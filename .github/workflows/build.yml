name: Build & Release

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ISO
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso make

      - name: Install Rust toolchain
        run: |
          rustup show
          rustc --version
          cargo --version

      - name: Cache Cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock', 'rust-toolchain.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Limine
        uses: actions/cache@v4
        with:
          path: limine
          key: limine-v8.x-binary

      - name: Build kernel
        run: make kernel

      - name: Create bootable ISO
        run: make iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: minimalos-${{ github.sha }}
          path: build/dist/minimalos.iso
          retention-days: 30

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: minimalos-${{ github.sha }}
          path: dist

      - name: Rename ISO with version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          cp dist/minimalos.iso "dist/minimalos-${VERSION}-x86_64.iso"
          sha256sum dist/minimalos-${VERSION}-x86_64.iso > "dist/minimalos-${VERSION}-x86_64.iso.sha256"

      - name: Prepare release body
        id: release_body
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          SHA256=$(cat dist/minimalos-${VERSION}-x86_64.iso.sha256 | awk '{print $1}')
          cat >> "$GITHUB_OUTPUT" <<EOF
          body<<RELEASE_BODY
          ## MinimalOS ${VERSION}

          ### ðŸ“¥ Download & Install

          1. Download \`minimalos-${VERSION}-x86_64.iso\` from the assets below
          2. Verify the checksum:
             \`\`\`
             sha256sum minimalos-${VERSION}-x86_64.iso
             # Expected: ${SHA256}
             \`\`\`
          3. Boot from the ISO using QEMU, VirtualBox, or write to a USB drive

          ---
          RELEASE_BODY
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          generate_release_notes: true
          body: ${{ steps.release_body.outputs.body }}
          append_body: true
          files: |
            dist/minimalos-*-x86_64.iso
            dist/minimalos-*-x86_64.iso.sha256
